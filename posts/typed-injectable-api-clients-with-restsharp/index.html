<!doctype html><html lang=en><head><title>Typed injectable API clients with RestSharp · frikyfriky11
</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="Stefano Previato"><meta name=description content="When working with external APIs, it is useful to create a typed API client that can be injected in your code through the Dependency Injection mechanism. RestSharp can help with this."><meta name=keywords content="blog,developer,personal,software engineer"><meta name=twitter:card content="summary"><meta name=twitter:title content="Typed injectable API clients with RestSharp"><meta name=twitter:description content="When working with external APIs, it is useful to create a typed API client that can be injected in your code through the Dependency Injection mechanism. RestSharp can help with this."><meta property="og:title" content="Typed injectable API clients with RestSharp"><meta property="og:description" content="When working with external APIs, it is useful to create a typed API client that can be injected in your code through the Dependency Injection mechanism. RestSharp can help with this."><meta property="og:type" content="article"><meta property="og:url" content="https://frikyfriky11.github.io/posts/typed-injectable-api-clients-with-restsharp/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-01-11T12:35:17+01:00"><meta property="article:modified_time" content="2024-01-11T12:35:17+01:00"><link rel=canonical href=https://frikyfriky11.github.io/posts/typed-injectable-api-clients-with-restsharp/><link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.e1bdf152d93b060b06ba5d496486ed9c201a8b95d335e035beb5faebe3b61cad.css integrity="sha256-4b3xUtk7BgsGul1JZIbtnCAai5XTNeA1vrX66+O2HK0=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin=anonymous media=screen><link rel=icon type=image/svg+xml href=/images/favicon.svg sizes=any><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>frikyfriky11
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/posts/>Posts</a></li><li class=navigation-item><a class=navigation-link href=/categories/>Categories</a></li><li class=navigation-item><a class=navigation-link href=/tags/>Tags</a></li><li class=navigation-item><a class=navigation-link href=/about/>About me</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://frikyfriky11.github.io/posts/typed-injectable-api-clients-with-restsharp/>Typed injectable API clients with RestSharp</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2024-01-11T12:35:17+01:00>January 11, 2024
</time></span><span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>
4-minute read</span></div><div class=authors><i class="fa fa-user" aria-hidden=true></i>
<a href=/authors/stefano-previato/>Stefano Previato</a></div><div class=categories><i class="fa fa-folder" aria-hidden=true></i>
<a href=/categories/c#/>C#</a>
<span class=separator>•</span>
<a href=/categories/programming/>Programming</a></div><div class=tags><i class="fa fa-tag" aria-hidden=true></i>
<span class=tag><a href=/tags/c#/>C#</a>
</span><span class=separator>•</span>
<span class=tag><a href=/tags/restsharp/>RestSharp</a></span></div></div></header><div class=post-content><h2 id=preface>Preface
<a class=heading-link href=#preface><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>In my day-to-day work, I often find myself needing to access external data via an external API.</p><p>If you&rsquo;re using C# and recent versions of .NET (both ASP.NET Core and Worker flavors) and need to do something similar, you may find useful to create a client for the external API and inject it whenever you need it via Dependency Injection.</p><p>Writing everything from scratch can lead to a lot of boilerplate. Luckily, we can use the help of a great library called <a href=https://restsharp.dev/ class=external-link target=_blank rel=noopener>RestSharp</a> (<a href=https://github.com/restsharp/RestSharp class=external-link target=_blank rel=noopener>GitHub</a>).</p><h2 id=required-packages>Required packages
<a class=heading-link href=#required-packages><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>Make sure to install the NuGet package for RestSharp in your project. This article was written with RestSharp v108.0.1, but you may check for updates and migration paths for newer versions on the official docs.</p><h2 id=creating-the-contract-for-the-api>Creating the contract for the API
<a class=heading-link href=#creating-the-contract-for-the-api><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>Let&rsquo;s start by declaring the shape of the API that we need to call:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#ff79c6>interface</span> <span style=color:#50fa7b>IMusicClient</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  Task&lt;IEnumerable&lt;SongData&gt;&gt; GetSongsAsync(Guid artistId, CancellationToken cancellationToken);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>and create an implementation of it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#ff79c6>class</span> <span style=color:#50fa7b>MusicClient</span> : IMusicClient
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#ff79c6>readonly</span> RestClient _restClient;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8be9fd;font-style:italic>public</span> MusicClient(RestClient restClient)
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    _restClient = restClient;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// provide the base URL for all calls</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// this should be coming from an IConfiguration or an IOption setting possibly</span>
</span></span><span style=display:flex><span>    _restClient.Options.BaseUrl = <span style=color:#ff79c6>new</span> Uri(<span style=color:#f1fa8c>&#34;https://your_external_api_uri&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// optionally inject default parameters in all calls</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// could be useful for setting the User-Agent, or maybe passing an authorization token or an API key</span>
</span></span><span style=display:flex><span>    _restClient.DefaultParameters.AddParameter(<span style=color:#ff79c6>new</span> HeaderParameter(<span style=color:#f1fa8c>&#34;Custom-Header&#34;</span>, <span style=color:#f1fa8c>&#34;CustomValueXYZ&#34;</span>));
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  Task&lt;IEnumerable&lt;SongData&gt;&gt; GetSongsAsync(Guid artistId, CancellationToken cancellationToken)
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// compose the URI of the resource (will be appended to the base URL)</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// you can pass parameters without string interpolation, they will be added a few lines after this line</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>const</span> <span style=color:#8be9fd>string</span> uri = <span style=color:#f1fa8c>&#34;MusicLibrary/Artists/{artistId}/Songs&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// create the request object</span>
</span></span><span style=display:flex><span>    RestRequest restRequest = <span style=color:#ff79c6>new</span>(uri);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// replace the URI parameters provided above</span>
</span></span><span style=display:flex><span>    restRequest.AddUrlSegment(<span style=color:#f1fa8c>&#34;artistId&#34;</span>, artistId);
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// there are also other utility methods such as AddQueryParameter();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// fire the request</span>
</span></span><span style=display:flex><span>    RestResponse&lt;IEnumerable&lt;SongData&gt;&gt; response = <span style=color:#ff79c6>await</span> _restClient.ExecuteAsync&lt;IEnumerable&lt;SongData&gt;&gt;(restRequest, cancellationToken);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// check if the response was successful, if not then throw an exception</span>
</span></span><span style=display:flex><span>    response.ThrowIfNotSuccessful();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// the content of the response inside .Data is typed!</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> response.Data;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>As you can see, the implementation is really straightforward, and we get a lot of benefits from using RestSharp:</p><ul><li>URI parameters handling</li><li>automatic deserialization of response data</li><li>header customization for all requests</li><li>error checking and exception throwing in case of failure</li><li>automatic cancellation handling via <code>CancellationToken</code></li><li>&mldr;and a lot more that you can find in the docs!</li></ul><h2 id=adding-the-services-to-the-di-container>Adding the services to the DI container
<a class=heading-link href=#adding-the-services-to-the-di-container><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>In your <code>Program.cs</code> (or wherever you have your host initialization code) add the required code for RestSharp and your custom implementations:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>static</span> <span style=color:#ff79c6>void</span> Main(<span style=color:#8be9fd>string</span>[] args)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  IHost host = Host.CreateDefaultBuilder(args)
</span></span><span style=display:flex><span>    .ConfigureServices((context, services) =&gt;
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#6272a4>// add RestSharp&#39;s client</span>
</span></span><span style=display:flex><span>      services.AddTransient&lt;RestClient&gt;();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#6272a4>// add the custom-made API client library</span>
</span></span><span style=display:flex><span>      services.AddSingleton&lt;IMusicClient, MusicClient&gt;();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#6272a4>// your other services...</span>
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>    .Build()
</span></span><span style=display:flex><span>    .Run();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=using-the-api-client>Using the API client
<a class=heading-link href=#using-the-api-client><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>At this point, you are ready to use the API client in your classes by injecting it via costructor injection for example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#ff79c6>class</span> <span style=color:#50fa7b>Worker</span> : BackgroundService
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#ff79c6>readonly</span> IMusicClient _musicClient;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8be9fd;font-style:italic>public</span> Worker(IMusicClient musicClient)
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    _musicClient = musicClient;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8be9fd;font-style:italic>protected</span> <span style=color:#8be9fd;font-style:italic>override</span> <span style=color:#8be9fd;font-style:italic>async</span> Task ExecuteAsync(CancellationToken stoppingToken)
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// call your API client methods</span>
</span></span><span style=display:flex><span>    _musicClient.GetSongsAsync(Guid.NewGuid(), stoppingToken);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// rest of your code...</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>That&rsquo;s it!</p><h2 id=testing>Testing
<a class=heading-link href=#testing><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>Creating a contract for your API client is a good way to abstract away the implementation details and enable you to test consumer code way better.</p><p>If you followed up until here, the <code>Worker</code> class is highly testable (at least from a unit-test perspective) because you can provide a fake implementation for the <code>IMusicClient</code> interface or even a mock and limit your tests to the logic of the worker itself, rather than focusing on testing the API calls too.</p><p>If you need to test the client itself without firing the actual requests over the network, you should check out a very good library called <code>RichardSzalay.MockHttp</code>.</p><p>Here&rsquo;s how a typical test would look like (using <code>NUnit</code>, <code>FluentAssertions</code> and <code>Moq</code>):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#50fa7b>[TestFixture]</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#ff79c6>class</span> <span style=color:#50fa7b>MusicClientTests</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span><span style=color:#50fa7b>  [SetUp]</span>
</span></span><span style=display:flex><span>  <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#ff79c6>void</span> SetUp()
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// setup a mock http message handler, so we don&#39;t actually connect to the network for the tests</span>
</span></span><span style=display:flex><span>    _mockHttpMessageHandler = <span style=color:#ff79c6>new</span> MockHttpMessageHandler();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// setup the RestSharp client with the mock http message handler</span>
</span></span><span style=display:flex><span>    _restClient = <span style=color:#ff79c6>new</span> RestClient(_mockHttpMessageHandler);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8be9fd;font-style:italic>private</span> MockHttpMessageHandler _mockHttpMessageHandler = <span style=color:#ff79c6>null</span>!;
</span></span><span style=display:flex><span>  <span style=color:#8be9fd;font-style:italic>private</span> RestClient _restClient = <span style=color:#ff79c6>null</span>!;
</span></span><span style=display:flex><span><span style=color:#50fa7b>
</span></span></span><span style=display:flex><span><span style=color:#50fa7b>  [Test]</span>
</span></span><span style=display:flex><span>  <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>async</span> Task GetSongsAsync_ShouldMakeTheCorrectRequest_WhenCalled()
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// arrange</span>
</span></span><span style=display:flex><span>    Guid artistId = Guid.NewGuid();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    IEnumerable&lt;SongData&gt; songData = CreateFakeSongData(); <span style=color:#6272a4>// omitted for brevity</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    _mockHttpMessageHandler
</span></span><span style=display:flex><span>      .Expect(HttpMethod.Get, <span style=color:#f1fa8c>$&#34;/MusicLibrary/Artists/{artistId}/Songs&#34;</span>)
</span></span><span style=display:flex><span>      .Respond(<span style=color:#f1fa8c>&#34;application/json&#34;</span>, JsonSerializer.Serialize(songData));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    MusicClient sut = <span style=color:#ff79c6>new</span>(_restClient);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// act</span>
</span></span><span style=display:flex><span>    List&lt;SongData&gt; result = (<span style=color:#ff79c6>await</span> sut.GetSongsAsync(artistId, CancellationToken.None)).ToList();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// assert</span>
</span></span><span style=display:flex><span>    _mockHttpMessageHandler.VerifyNoOutstandingExpectation();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    result.Should().NotBeNull();
</span></span><span style=display:flex><span>    result.Should().HaveCount(songData.Count());
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=conclusion>Conclusion
<a class=heading-link href=#conclusion><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>Whenever possible, you should try to take advantage of static and strong typing in C#, to allow you to reuse code and apply refactorings in a secure manner. On top of that, clean code is easier code usually, and RestSharp makes it really easy to parse the code visually while reading it.</p></div><footer></footer></article></section></div><footer class=footer><section class=container>©
2019 -
2024
Stefano Previato
·
Licensed under <a rel=license href=http://creativecommons.org/licenses/by-sa/4.0/>CC BY-SA-4.0</a>
·
Powered by <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/ target=_blank rel=noopener>Coder</a>.</section></footer></main><script src=/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script><script type=application/javascript>var _paq=window._paq=window._paq||[];_paq.push(["trackPageView"]),_paq.push(["enableLinkTracking"]),function(){e="https://matomo.frikydesign.it/",_paq.push(["setTrackerUrl",e+"matomo.php"]),_paq.push(["setSiteId","10"]);var e,n=document,t=n.createElement("script"),s=n.getElementsByTagName("script")[0];t.async=!0,t.src=e+"matomo.js",s.parentNode.insertBefore(t,s)}()</script></body></html>